version: 2.1

jobs:
  linux64_anaconda3_conda_build:
    docker:
      - image: continuumio/anaconda3
    steps:
      - checkout
      - run:
          name: Build and test
          command: |
            apt-get install make
            conda install conda-build -y
            conda config --add channels ggarrett13
            conda config --add channels conda-forge
            conda-build .circleci/test.conda.recipe
          persist_to_workspace:
            root: /opt/conda/conda-bld/
            paths:
              - linux-64/
      - store_artifacts:
          path: /opt/conda/conda-bld/linux-64/
          destination: /linux-64

  linux64_miniconda3_conda_build:
    docker:
      - image: continuumio/miniconda3
    working_directory: /tmp
    steps:
      - checkout
      - run:
          name: Build and test
          command: |
            apt-get install make
            conda install conda-build -y
            conda config --add channels ggarrett13
            conda config --add channels conda-forge
            conda-build .circleci/test.conda.recipe
          persist_to_workspace:
            root: /opt/conda/conda-bld
            paths:
              - linux-64/

      - store_artifacts:
          path: /opt/conda/conda-bld/linux-64
          destination: /linux-64

  linux64_anaconda3_conda_install:
    docker:
      - image: continuumio/anaconda3
    steps:
      - attach_workspace:
          at: /opt/conda/conda-bld/
      - run:
          name: Install and test
          command: |
            conda config --add channels ggarrett13
            conda config --add channels conda-forge
            conda install --use-local tudatpy

  linux64_miniconda3_conda_install:
    docker:
      - image: continuumio/miniconda3
    steps:
      - attach_workspace:
          at: /opt/conda/conda-bld
      - run:
          name: Install and test
          command: |
            conda config --add channels ggarrett13
            conda config --add channels conda-forge
            conda install --use-local tudatpy

workflows:
  version: 2.1
  all_builds:
    jobs:
      - linux64_anaconda3_conda_build
      - linux64_miniconda3_conda_build
  all_installs:
    jobs:
      - linux64_anaconda3_conda_install:
          requires:
            - linux64_anaconda3_conda_build
      - linux64_miniconda3_conda_install:
          requires:
            - linux64_miniconda3_conda_build